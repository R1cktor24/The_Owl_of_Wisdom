<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–æ–≤–∞ –ú—É–¥—Ä–æ—Å—Ç—ñ ü¶â</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .screen { display: none; }
        .screen.active { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { color: #333; margin-bottom: 20px; text-align: center; }
        h1 { font-size: 2em; }
        h2 { font-size: 1.5em; }

        .menu-buttons { display: flex; flex-direction: column; gap: 15px; }

        button {
            padding: 15px 20px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: white;
        }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-secondary { background: #48bb78; }
        .btn-danger { background: #f56565; }
        .btn-action { flex: 1; padding: 12px; font-size: 1em; }
        button:hover:not(:disabled) { opacity: 0.9; }

        .nickname-form { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 8px; color: #333; }

        input[type="text"] {
            padding: 12px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 1em;
        }
        input[type="text"]:focus { outline: none; border-color: #667eea; }
        input[type="file"] { display: none; }

        /* SETUP */
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f7ff;
            margin: 10px 0;
        }
        .upload-zone:hover { background: #ede9ff; border-color: #764ba2; }
        .upload-zone.has-files { border-style: solid; background: #f0fff4; border-color: #48bb78; }
        .upload-icon { font-size: 3em; margin-bottom: 10px; }
        .upload-text { color: #667eea; font-weight: bold; font-size: 1.1em; }
        .upload-sub { color: #999; font-size: 0.85em; margin-top: 5px; }

        .images-preview {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 12px 0;
        }
        .preview-slot {
            aspect-ratio: 2/3;
            border-radius: 8px;
            border: 2px solid #eee;
            overflow: hidden;
            position: relative;
            background: #f7fafc;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; color: #ccc;
        }
        .preview-slot img { width: 100%; height: 100%; object-fit: cover; }
        .preview-slot.is-trump { border: 3px solid #f6ad55; }
        .preview-slot.is-trump::after {
            content: '‚≠ê';
            position: absolute; top: 2px; right: 3px;
            font-size: 0.8em;
        }
        .preview-slot .slot-num {
            position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
            font-size: 0.5em; background: rgba(0,0,0,0.5);
            color: white; padding: 1px 5px; border-radius: 4px;
            font-weight: bold;
        }

        .trump-select { margin: 10px 0; }
        .trump-select label { display: block; margin-bottom: 8px; }
        .trump-btns { display: flex; gap: 6px; flex-wrap: wrap; }
        .trump-btn {
            padding: 8px 14px; font-size: 0.85em;
            background: #eee; color: #333;
            border-radius: 8px; border: 2px solid #ddd;
        }
        .trump-btn.active { background: #f6ad55; border-color: #ed8936; color: white; }

        /* WAITING */
        .link-section { text-align: center; }
        .link-box {
            background: #f7fafc; padding: 15px; border-radius: 8px;
            margin: 20px 0; font-family: 'Courier New', monospace;
            font-size: 1.4em; color: #2d3748;
            border: 2px dashed #667eea;
            letter-spacing: 8px; font-weight: bold;
        }
        .btn-copy { background: #4299e1; margin-bottom: 15px; }
        .copy-success { color: #48bb78; font-weight: bold; margin-top: 10px; min-height: 24px; }
        .waiting-text { color: #666; margin: 20px 0; font-size: 1.1em; }
        .loader {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid #f3f3f3; border-top: 3px solid #667eea;
            border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* GAME */
        .game-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #eee;
        }
        .player-info { text-align: center; flex: 1; }
        .player-name { font-weight: bold; font-size: 1.1em; color: #333; }
        .player-hand-count { color: #666; font-size: 0.9em; margin-top: 5px; }
        .vs-text { color: #999; margin: 0 10px; }

        .stats-bar {
            display: flex; justify-content: space-around; gap: 10px;
            margin-bottom: 15px; background: #f7fafc; padding: 12px; border-radius: 8px;
        }
        .stat-item { text-align: center; }
        .stat-label { font-size: 0.85em; color: #666; }
        .stat-value { font-size: 1.4em; font-weight: bold; color: #333; }

        .trump-bar {
            display: flex; align-items: center; gap: 8px;
            background: #fffbeb; border: 1px solid #f6ad55;
            border-radius: 8px; padding: 8px 12px;
            margin-bottom: 12px; font-size: 0.9em; color: #744210;
        }
        .trump-bar-img {
            width: 28px; height: 42px; border-radius: 4px;
            overflow: hidden; border: 1px solid #f6ad55;
        }
        .trump-bar-img img { width: 200%; height: 100%; object-fit: cover; margin-left: 0; }

        .table-area {
            background: #2d5016; border-radius: 15px; padding: 15px;
            min-height: 160px; margin-bottom: 15px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 10px;
        }
        .table-cards {
            display: flex; flex-wrap: wrap; gap: 8px;
            justify-content: center; min-height: 70px; align-items: center;
        }
        .card-on-table {
            height: 90px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        .card-on-table.trump { border-color: #f6ad55; box-shadow: 0 0 10px rgba(246,173,85,0.6); }

        .game-status {
            color: white; font-weight: bold; font-size: 1em;
            background: rgba(255,255,255,0.15); padding: 6px 16px;
            border-radius: 20px;
        }

        .opponent-cards {
            display: flex; flex-wrap: wrap; gap: 6px;
            justify-content: center; margin-bottom: 15px;
        }
        .card-back {
            width: 50px; height: 75px; border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 2px solid white; display: flex;
            align-items: center; justify-content: center;
            font-size: 1.2em;
        }

        .my-cards { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .card-in-hand {
            height: 90px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        .card-in-hand:active { transform: scale(0.95); }
        .card-in-hand.selected { transform: translateY(-12px); border-color: #667eea; box-shadow: 0 6px 20px rgba(102,126,234,0.5); }
        .card-in-hand.trump { border-color: #f6ad55; }
        .card-in-hand.trump.selected { border-color: #ed8936; box-shadow: 0 6px 20px rgba(246,173,85,0.6); }

        .action-buttons { display: flex; gap: 10px; margin-top: 10px; }

        /* RESULT */
        .result-section { text-align: center; padding: 20px 0; }
        .result-winner { font-size: 2.5em; margin-bottom: 15px; }
        .result-scores {
            display: flex; justify-content: space-around;
            background: #f7fafc; padding: 20px; border-radius: 12px; margin: 20px 0;
        }
        .result-player { text-align: center; }
        .result-player-name { font-weight: bold; color: #333; margin-bottom: 8px; }
        .result-player-wins { font-size: 2em; font-weight: bold; color: #667eea; }

        .error-msg { color: #f56565; text-align: center; font-weight: bold; margin: 10px 0; min-height: 24px; }
        .info-msg { color: #667eea; text-align: center; margin: 10px 0; }
    </style>
</head>
<body>
<div class="container">

    <!-- –ú–ï–ù–Æ -->
    <div class="screen active" id="screen-menu">
        <h1>ü¶â –°–æ–≤–∞ –ú—É–¥—Ä–æ—Å—Ç—ñ</h1>
        <div class="menu-buttons">
            <button class="btn-primary" onclick="goToSetup()">üéÆ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
            <button class="btn-secondary" onclick="showScreen('screen-join')">üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
        </div>
    </div>

    <!-- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø (—Ö–æ—Å—Ç) -->
    <div class="screen" id="screen-setup">
        <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏</h2>
        <div class="nickname-form">
            <div class="form-group">
                <label>–¢–≤—ñ–π –Ω—ñ–∫–Ω–µ–π–º:</label>
                <input type="text" id="host-nick" placeholder="–í–≤–µ–¥–∏ –Ω—ñ–∫–Ω–µ–π–º" maxlength="16" />
            </div>

            <div class="form-group">
                <label>–ó–∞–≤–∞–Ω—Ç–∞–∂ —Ä—ñ–≤–Ω–æ 5 –∫–∞—Ä—Ç–∏–Ω–æ–∫ –æ–¥—Ä–∞–∑—É:</label>
                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">–ù–∞—Ç–∏—Å–Ω–∏ —â–æ–± –≤–∏–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ</div>
                    <div class="upload-sub">–í–∏–±–µ—Ä–∏ –≤—Å—ñ 5 —Ñ–æ—Ç–æ –æ–¥—Ä–∞–∑—É (Ctrl+A –∞–±–æ Shift+–∫–ª—ñ–∫)</div>
                </div>
                <input type="file" id="file-input" accept="image/*" multiple onchange="onFilesSelected()" />
            </div>

            <div class="images-preview" id="images-preview">
                <div class="preview-slot">üì∑<div class="slot-num">1</div></div>
                <div class="preview-slot">üì∑<div class="slot-num">2</div></div>
                <div class="preview-slot">üì∑<div class="slot-num">3</div></div>
                <div class="preview-slot">üì∑<div class="slot-num">4</div></div>
                <div class="preview-slot">üì∑<div class="slot-num">5</div></div>
            </div>

            <div class="trump-select" id="trump-select" style="display:none">
                <label>‚≠ê –í–∏–±–µ—Ä–∏ –∫–æ–∑–∏—Ä—è:</label>
                <div class="trump-btns" id="trump-btns"></div>
            </div>

            <div class="error-msg" id="setup-error"></div>
            <button class="btn-primary" id="btn-start-create" onclick="createGame()" disabled>üöÄ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
            <button class="btn-danger" onclick="showScreen('screen-menu')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <!-- –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–Ø -->
    <div class="screen" id="screen-join">
        <h2>üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</h2>
        <div class="nickname-form">
            <div class="form-group">
                <label>–¢–≤—ñ–π –Ω—ñ–∫–Ω–µ–π–º:</label>
                <input type="text" id="guest-nick" placeholder="–í–≤–µ–¥–∏ –Ω—ñ–∫–Ω–µ–π–º" maxlength="16" />
            </div>
            <div class="form-group">
                <label>–ö–æ–¥ –≥—Ä–∏:</label>
                <input type="text" id="join-code" placeholder="6 —Å–∏–º–≤–æ–ª—ñ–≤" maxlength="6" style="text-transform:uppercase;letter-spacing:4px;font-size:1.3em;text-align:center" />
            </div>
            <div class="error-msg" id="join-error"></div>
            <button class="btn-secondary" onclick="joinGame()">üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
            <button class="btn-danger" onclick="showScreen('screen-menu')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <!-- –û–ß–Ü–ö–£–í–ê–ù–ù–Ø -->
    <div class="screen" id="screen-waiting">
        <h2>‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—è...</h2>
        <div class="link-section">
            <p class="waiting-text">–ü–æ–¥—ñ–ª–∏—Å—è –∫–æ–¥–æ–º –∑ –¥—Ä—É–≥–æ–º:</p>
            <div class="link-box" id="game-code-display">------</div>
            <button class="btn-copy" onclick="copyCode()">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥</button>
            <div class="copy-success" id="copy-success"></div>
        </div>
        <div style="text-align:center"><div class="loader"></div></div>
        <p class="info-msg">–û—á—ñ–∫—É—é –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</p>
        <button class="btn-danger" onclick="cancelGame()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>

    <!-- –ì–†–ê -->
    <div class="screen" id="screen-game">
        <div class="game-header">
            <div class="player-info">
                <div class="player-name" id="player1Name">–ì—Ä–∞–≤–µ—Ü—å 1</div>
                <div class="player-hand-count" id="player1Hand">5 –∫–∞—Ä—Ç</div>
            </div>
            <div class="vs-text">‚öîÔ∏è</div>
            <div class="player-info">
                <div class="player-name" id="player2Name">–ì—Ä–∞–≤–µ—Ü—å 2</div>
                <div class="player-hand-count" id="player2Hand">5 –∫–∞—Ä—Ç</div>
            </div>
        </div>

        <div class="trump-bar">
            <div class="trump-bar-img"><img id="trump-bar-img" src="" /></div>
            <span>‚≠ê –ö–æ–∑–∏—Ä</span>
        </div>

        <div class="table-area">
            <div class="game-status" id="gameStatus">...</div>
            <div class="table-cards" id="tableCards"></div>
        </div>

        <div class="opponent-cards" id="opponentCards"></div>

        <div class="my-cards" id="myCards"></div>

        <div class="action-buttons" id="action-buttons">
            <button class="btn-primary btn-action" id="btn-play" onclick="playCard()">‚öîÔ∏è –•–æ–¥–∏—Ç–∏</button>
            <button class="btn-secondary btn-action" id="btn-beat" onclick="beatCard()" style="display:none">üõ°Ô∏è –í—ñ–¥–±–∏—Ç–∏</button>
            <button class="btn-danger btn-action" id="btn-take" onclick="takeCards()" style="display:none">‚òùÔ∏è –í–∑—è—Ç–∏</button>
        </div>
    </div>

    <!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
    <div class="screen" id="screen-result">
        <div class="result-section">
            <div class="result-winner" id="resultWinner">üéâ –í–∏ –≤–∏–≥—Ä–∞–ª–∏!</div>
            <div class="result-scores">
                <div class="result-player">
                    <div class="result-player-name" id="resultPlayer1">–ì—Ä–∞–≤–µ—Ü—å 1</div>
                    <div class="result-player-wins" id="resultWins1">0</div>
                    <div style="color:#999;font-size:0.8em">–ø–µ—Ä–µ–º–æ–≥</div>
                </div>
                <div class="result-player">
                    <div class="result-player-name" id="resultPlayer2">–ì—Ä–∞–≤–µ—Ü—å 2</div>
                    <div class="result-player-wins" id="resultWins2">0</div>
                    <div style="color:#999;font-size:0.8em">–ø–µ—Ä–µ–º–æ–≥</div>
                </div>
            </div>
            <button class="btn-primary" onclick="location.reload()">üîÑ –ù–æ–≤–∞ –≥—Ä–∞</button>
        </div>
    </div>

</div>

<script>
// ======= –ó–ê–ú–Ü–ù–ò –ù–ê –°–í–û–Ñ NGROK –ü–û–°–ò–õ–ê–ù–ù–Ø =======
const SERVER_URL = 'wss://tranquil-houston-aforethought.ngrok-free.dev';

// ======= STATE =======
let ws = null;
let myRole = null;       // 'host' –∞–±–æ 'guest'
let myNick = '';
let opNick = '';
let myHand = [];
let opponentHandCount = 0;
let phase = 'idle';      // idle / attack / defend / wait
let selectedCardIdx = null;
let trumpImg = -1;
let fieldCard = null;
let CARD_IMAGES = [];
let myWins = 0;
let opWins = 0;

// ======= SETUP =======
function goToSetup() {
    showScreen('screen-setup');
}

function onFilesSelected() {
    const files = Array.from(document.getElementById('file-input').files);
    const err = document.getElementById('setup-error');

    if (files.length !== 5) {
        err.textContent = `‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–æ —Ä—ñ–≤–Ω–æ 5 —Ñ–æ—Ç–æ! –¢–∏ –≤–∏–±—Ä–∞–≤ ${files.length}.`;
        return;
    }
    err.textContent = '';

    CARD_IMAGES = [];
    let loaded = 0;

    files.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            CARD_IMAGES[idx] = e.target.result;
            loaded++;

            // –û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–µ–≤—å—é
            const preview = document.getElementById('images-preview');
            const slots = preview.querySelectorAll('.preview-slot');
            slots[idx].innerHTML = `<img src="${e.target.result}" /><div class="slot-num">${idx+1}</div>`;

            if (loaded === 5) {
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –≤–∏–±—ñ—Ä –∫–æ–∑–∏—Ä—è
                document.getElementById('trump-select').style.display = 'block';
                const btns = document.getElementById('trump-btns');
                btns.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const b = document.createElement('button');
                    b.textContent = `–ö–∞—Ä—Ç–∏–Ω–∫–∞ ${i+1}`;
                    b.className = 'trump-btn' + (i === 0 ? ' active' : '');
                    b.onclick = () => selectTrump(i);
                    btns.appendChild(b);
                }
                trumpImg = 0;
                document.getElementById('images-preview').querySelectorAll('.preview-slot')[0].classList.add('is-trump');

                document.getElementById('upload-zone').classList.add('has-files');
                document.getElementById('upload-zone').querySelector('.upload-text').textContent = '‚úÖ 5 —Ñ–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!';
                document.getElementById('btn-start-create').disabled = false;
            }
        };
        reader.readAsDataURL(file);
    });
}

function selectTrump(idx) {
    trumpImg = idx;
    document.querySelectorAll('.trump-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    document.querySelectorAll('.preview-slot').forEach((s, i) => s.classList.toggle('is-trump', i === idx));
}

// ======= WEBSOCKET =======
function connect(cb) {
    ws = new WebSocket(SERVER_URL);
    ws.onopen = cb;
    ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
    ws.onerror = () => alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞!');
    ws.onclose = () => {
        if (document.getElementById('screen-game').classList.contains('active')) {
            showScreen('screen-result');
            document.getElementById('resultWinner').textContent = 'üíî –°—É–ø–µ—Ä–Ω–∏–∫ –≤—ñ–¥–∫–ª—é—á–∏–≤—Å—è';
        }
    };
}

function sendWS(data) {
    if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(data));
}

// ======= ACTIONS =======
function createGame() {
    myNick = document.getElementById('host-nick').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å 1';
    if (CARD_IMAGES.length !== 5) { document.getElementById('setup-error').textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂ 5 —Ñ–æ—Ç–æ!'; return; }
    connect(() => sendWS({ type: 'create-game', nickname: myNick, images: CARD_IMAGES, trumpImg }));
}

function joinGame() {
    myNick = document.getElementById('guest-nick').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å 2';
    const code = document.getElementById('join-code').value.trim().toUpperCase();
    if (!code) { document.getElementById('join-error').textContent = '–í–≤–µ–¥–∏ –∫–æ–¥ –≥—Ä–∏!'; return; }
    connect(() => sendWS({ type: 'join-game', gameId: code, nickname: myNick }));
}

function copyCode() {
    const code = document.getElementById('game-code-display').textContent;
    navigator.clipboard.writeText(code).then(() => {
        document.getElementById('copy-success').textContent = '‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!';
        setTimeout(() => document.getElementById('copy-success').textContent = '', 2000);
    });
}

function cancelGame() {
    if (ws) ws.close();
    showScreen('screen-menu');
}

function playCard() {
    if (selectedCardIdx === null) { alert('–í–∏–±–µ—Ä–∏ –∫–∞—Ä—Ç—É!'); return; }
    const card = myHand[selectedCardIdx];
    if (card.isTrump && myHand.length === 1) { alert('‚ùå –ö–æ–∑–∏—Ä–µ–º –Ω–µ –º–æ–∂–Ω–∞ —Ö–æ–¥–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—å–æ—é –∫–∞—Ä—Ç–æ—é!'); return; }
    sendWS({ type: 'attack', card: { img: card.img, half: card.half } });
}

function beatCard() {
    if (selectedCardIdx === null) { alert('–í–∏–±–µ—Ä–∏ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ñ–¥–±–∏—Ç—Ç—è!'); return; }
    const card = myHand[selectedCardIdx];
    if (card.isTrump && myHand.length === 1) { alert('‚ùå –ö–æ–∑–∏—Ä–µ–º –Ω–µ –º–æ–∂–Ω–∞ –≤—ñ–¥–±–∏–≤–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—å–æ—é –∫–∞—Ä—Ç–æ—é!'); return; }
    sendWS({ type: 'defend', card: { img: card.img, half: card.half } });
}

function takeCards() {
    selectedCardIdx = null;
    sendWS({ type: 'take-cards' });
}

function selectCard(idx) {
    if (phase !== 'attack' && phase !== 'defend') return;
    selectedCardIdx = selectedCardIdx === idx ? null : idx;
    renderMyCards();
}

// ======= MESSAGE HANDLER =======
function handleMessage(data) {
    switch(data.type) {
        case 'game-created':
            document.getElementById('game-code-display').textContent = data.gameId;
            showScreen('screen-waiting');
            break;

        case 'player-joined':
            opNick = data.guestNick;
            setTimeout(() => sendWS({ type: 'start-game' }), 500);
            break;

        case 'joined':
            opNick = data.hostNick;
            CARD_IMAGES = data.images;
            trumpImg = data.trumpImg;
            break;

        case 'game-start':
            myRole = data.role;
            trumpImg = data.trumpImg;
            CARD_IMAGES = data.images;
            myHand = data.hand.map(c => ({ ...c, isTrump: c.img === trumpImg }));
            opponentHandCount = 5;
            fieldCard = null;
            selectedCardIdx = null;
            phase = data.attacker === myRole ? 'attack' : 'wait';
            setupGameUI();
            showScreen('screen-game');
            break;

        case 'attack-sent':
            myHand = data.hand.map(c => ({ ...c, isTrump: c.img === trumpImg }));
            fieldCard = data.card;
            phase = 'wait';
            renderAll();
            break;

        case 'incoming-attack':
            fieldCard = data.card;
            phase = 'defend';
            opponentHandCount--;
            renderAll();
            break;

        case 'defend-success':
            myHand = data.hand.map(c => ({ ...c, isTrump: c.img === trumpImg }));
            fieldCard = null;
            selectedCardIdx = null;
            phase = data.attacker === myRole ? 'attack' : 'wait';
            renderAll();
            break;

        case 'took-cards':
            myHand = data.hand.map(c => ({ ...c, isTrump: c.img === trumpImg }));
            fieldCard = null;
            selectedCardIdx = null;
            phase = 'wait';
            renderAll();
            break;

        case 'opponent-took':
            opponentHandCount += fieldCard ? 1 : 0;
            fieldCard = null;
            selectedCardIdx = null;
            phase = 'attack';
            renderAll();
            break;

        case 'invalid-defend':
            alert('‚ùå –¢–∞–∫ –Ω–µ –º–æ–∂–Ω–∞ –≤—ñ–¥–±–∏—Ç–∏!');
            break;

        case 'error':
            document.getElementById('join-error').textContent = '‚ùå ' + data.message;
            break;

        case 'game-over':
            const iWon = data.winner === myRole;
            if (iWon) myWins++; else opWins++;
            showResult(iWon, data.winnerNick);
            break;

        case 'opponent-left':
            showResult(true, myNick);
            break;
    }
}

// ======= RENDER =======
function setupGameUI() {
    document.getElementById('player1Name').textContent = myNick;
    document.getElementById('player2Name').textContent = opNick;

    // trump preview
    const img = document.getElementById('trump-bar-img');
    img.src = CARD_IMAGES[trumpImg];
    img.style.marginLeft = '0';
}

function renderAll() {
    renderMyCards();
    renderOpponentCards();
    renderTable();
    renderStatus();
    renderButtons();
}

function renderMyCards() {
    const div = document.getElementById('myCards');
    div.innerHTML = '';
    myHand.forEach((card, idx) => {
        const img = document.createElement('img');
        img.src = getCardImage(card);
        img.className = 'card-in-hand' + (card.isTrump ? ' trump' : '') + (selectedCardIdx === idx ? ' selected' : '');
        img.onclick = () => selectCard(idx);
        div.appendChild(img);
    });
    document.getElementById('player1Hand').textContent = `${myHand.length} –∫–∞—Ä—Ç`;
}

function renderOpponentCards() {
    const div = document.getElementById('opponentCards');
    div.innerHTML = '';
    for (let i = 0; i < opponentHandCount; i++) {
        const d = document.createElement('div');
        d.className = 'card-back';
        d.textContent = 'ü¶â';
        div.appendChild(d);
    }
    document.getElementById('player2Hand').textContent = `${opponentHandCount} –∫–∞—Ä—Ç`;
}

function renderTable() {
    const div = document.getElementById('tableCards');
    div.innerHTML = '';
    if (!fieldCard) return;
    const img = document.createElement('img');
    img.src = getCardImage(fieldCard);
    img.className = 'card-on-table' + (fieldCard.img === trumpImg ? ' trump' : '');
    div.appendChild(img);
}

function renderStatus() {
    const s = document.getElementById('gameStatus');
    if (phase === 'attack') s.textContent = '‚öîÔ∏è –í–∞—à —Ö—ñ–¥';
    else if (phase === 'defend') s.textContent = 'üõ°Ô∏è –í—ñ–¥–±–∏–π—Ç–µ –∞–±–æ –≤—ñ–∑—å–º—ñ—Ç—å';
    else s.textContent = '‚è≥ –•—ñ–¥ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...';
}

function renderButtons() {
    const btnPlay = document.getElementById('btn-play');
    const btnBeat = document.getElementById('btn-beat');
    const btnTake = document.getElementById('btn-take');

    if (phase === 'attack') {
        btnPlay.style.display = 'block';
        btnBeat.style.display = 'none';
        btnTake.style.display = 'none';
    } else if (phase === 'defend') {
        btnPlay.style.display = 'none';
        btnBeat.style.display = 'block';
        btnTake.style.display = 'block';
    } else {
        btnPlay.style.display = 'none';
        btnBeat.style.display = 'none';
        btnTake.style.display = 'none';
    }
}

function getCardImage(card) {
    // –ú–∞–ª—é—î–º–æ –ø–æ–ª–æ–≤–∏–Ω—É –∫–∞—Ä—Ç–∏–Ω–∫–∏ —á–µ—Ä–µ–∑ canvas
    const src = CARD_IMAGES[card.img];
    const half = card.half; // 0=left, 1=right
    const canvas = document.createElement('canvas');
    const img = new Image();
    img.src = src;

    // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ data URL —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —è–∫—â–æ –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ
    if (img.complete && img.naturalWidth > 0) {
        canvas.width = img.naturalWidth / 2;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        const sx = half === 0 ? 0 : img.naturalWidth / 2;
        ctx.drawImage(img, sx, 0, img.naturalWidth / 2, img.naturalHeight, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL();
    }
    // –Ø–∫—â–æ —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ‚Äî –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–∞–≥–ª—É—à–∫—É —ñ –ø–µ—Ä–µ–º–∞–ª—é–≤–∞—Ç–∏ –ø–æ—Ç—ñ–º
    img.onload = () => renderAll();
    return src; // —Ç–∏–º—á–∞—Å–æ–≤–æ –ø–æ–≤–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞
}

function showResult(iWon, winnerNick) {
    document.getElementById('resultWinner').textContent = iWon ? 'üéâ –í–∏ –≤–∏–≥—Ä–∞–ª–∏!' : 'üòî –í–∏ –ø—Ä–æ–≥—Ä–∞–ª–∏';
    document.getElementById('resultPlayer1').textContent = myNick;
    document.getElementById('resultPlayer2').textContent = opNick;
    document.getElementById('resultWins1').textContent = myWins;
    document.getElementById('resultWins2').textContent = opWins;
    showScreen('screen-result');
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}
</script>
</body>
</html>
