<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–æ–≤–∞ –ú—É–¥—Ä–æ—Å—Ç—ñ ü¶â</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 0;
            padding: 16px;
            min-height: 100vh;
            box-shadow: none;
        }
        @media (min-width: 520px) {
            body { padding: 10px; }
            .container { border-radius: 15px; min-height: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        }
        .screen { display: none; }
        .screen.active { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        h1, h2 { color:#333; margin-bottom:20px; text-align:center; }
        h1 { font-size:2em; } h2 { font-size:1.5em; }
        .menu-buttons { display:flex; flex-direction:column; gap:15px; }

        button {
            padding:15px 20px; font-size:1.1em; border:none;
            border-radius:10px; cursor:pointer; transition:all 0.3s;
            font-weight:bold; color:white;
        }
        button:active { transform:scale(0.95); }
        button:disabled { opacity:0.4; cursor:not-allowed; transform:none; }
        .btn-primary { background:linear-gradient(135deg,#667eea,#764ba2); }
        .btn-secondary { background:#48bb78; }
        .btn-danger { background:#f56565; }
        .btn-action { flex:1; padding:12px; font-size:1em; }
        button:hover:not(:disabled) { opacity:0.9; }

        input[type="text"] {
            padding:12px; border:2px solid #ddd;
            border-radius:8px; font-size:1em; width:100%;
        }
        input[type="text"]:focus { outline:none; border-color:#667eea; }
        input[type="file"] { display:none; }

        .form-group { display:flex; flex-direction:column; gap:8px; margin-bottom:15px; }
        label { font-weight:bold; color:#333; }

        /* UPLOAD */
        .upload-zone {
            border:3px dashed #667eea; border-radius:12px;
            padding:30px 20px; text-align:center; cursor:pointer;
            background:#f8f7ff; transition:all 0.3s;
        }
        .upload-zone:hover { background:#ede9ff; }
        .upload-zone.done { border-style:solid; background:#f0fff4; border-color:#48bb78; }
        .upload-icon { font-size:3em; margin-bottom:8px; }
        .upload-text { color:#667eea; font-weight:bold; font-size:1.1em; }
        .upload-sub { color:#999; font-size:0.82em; margin-top:5px; }

        .images-preview {
            display:grid; grid-template-columns:repeat(5,1fr);
            gap:8px; margin:12px 0;
        }
        .preview-slot {
            aspect-ratio:2/3; border-radius:8px; border:2px solid #eee;
            overflow:hidden; position:relative; background:#f7fafc;
            display:flex; align-items:center; justify-content:center;
            font-size:1.4em; color:#ccc;
        }
        .preview-slot img { width:100%; height:100%; object-fit:cover; }
        .preview-slot.trump { border:3px solid #f6ad55; }
        .preview-slot.trump::after { content:'‚≠ê'; position:absolute; top:2px; right:3px; font-size:0.75em; }
        .slot-num {
            position:absolute; bottom:2px; left:50%; transform:translateX(-50%);
            font-size:0.5em; background:rgba(0,0,0,0.5); color:white;
            padding:1px 5px; border-radius:4px; font-weight:bold;
        }

        .trump-select { margin:10px 0; }
        .trump-btns { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
        .trump-btn {
            padding:7px 12px; font-size:0.82em; background:#eee;
            color:#333; border-radius:8px; border:2px solid #ddd; cursor:pointer;
        }
        .trump-btn.active { background:#f6ad55; border-color:#ed8936; color:white; }

        /* WAITING */
        .link-box {
            background:#f7fafc; padding:15px; border-radius:8px;
            margin:15px 0; font-size:2em; color:#333; letter-spacing:10px;
            font-weight:bold; text-align:center; border:2px dashed #667eea;
        }
        .copy-success { color:#48bb78; font-weight:bold; text-align:center; min-height:22px; }
        .loader {
            display:block; width:24px; height:24px; margin:15px auto;
            border:3px solid #eee; border-top-color:#667eea;
            border-radius:50%; animation:spin 1s linear infinite;
        }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* GAME */
        .game-header {
            display:flex; justify-content:space-between; align-items:center;
            margin-bottom:12px; padding-bottom:12px; border-bottom:2px solid #eee;
        }
        .player-info { text-align:center; flex:1; }
        .player-name { font-weight:bold; font-size:1em; color:#333; }
        .player-hand-count { color:#666; font-size:0.85em; margin-top:4px; }
        .vs-text { color:#999; margin:0 8px; }

        .trump-bar {
            display:flex; align-items:center; gap:10px;
            background:#fffbeb; border:1px solid #f6ad55;
            border-radius:8px; padding:8px 12px; margin-bottom:12px;
            font-size:0.9em; color:#744210; font-weight:bold;
        }
        .trump-thumb {
            width:30px; height:45px; border-radius:5px;
            overflow:hidden; border:1px solid #f6ad55; flex-shrink:0;
        }
        .trump-thumb canvas { width:100%; height:100%; display:block; }

        .table-area {
            background:#2d5016; border-radius:15px; padding:15px;
            min-height:150px; margin-bottom:12px;
            display:flex; flex-direction:column;
            justify-content:center; align-items:center; gap:10px;
        }
        .game-status {
            color:white; font-weight:bold;
            background:rgba(255,255,255,0.15); padding:5px 16px; border-radius:20px;
            font-size:0.95em;
        }
        .table-cards { display:flex; gap:8px; justify-content:center; min-height:70px; align-items:center; }
        .card-on-table { height:115px; border-radius:8px; border:2px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3); }
        .card-on-table.trump { border-color:#f6ad55; box-shadow:0 0 10px rgba(246,173,85,0.7); }

        .opponent-cards { display:none; }
        .card-back { display:none; }

        .my-cards { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:12px; min-height:115px; }
        .card-in-hand {
            height:115px; border-radius:8px; cursor:pointer;
            border:2px solid transparent; transition:transform 0.15s, box-shadow 0.15s;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
        }
        .card-in-hand:active { transform:scale(0.95); }
        .card-in-hand.selected { transform:translateY(-12px); border-color:#667eea; box-shadow:0 6px 18px rgba(102,126,234,0.5); }
        .card-in-hand.trump { border-color:#f6ad55; }
        .card-in-hand.trump.selected { border-color:#ed8936; box-shadow:0 6px 18px rgba(246,173,85,0.6); }

        .action-buttons { display:flex; gap:10px; }
        .error-msg { color:#f56565; text-align:center; font-weight:bold; min-height:22px; margin:8px 0; }

        /* RESULT */
        .result-winner { font-size:2.5em; text-align:center; margin:15px 0; }
        .result-scores {
            display:flex; justify-content:space-around;
            background:#f7fafc; padding:20px; border-radius:12px; margin:15px 0;
        }
        .result-player { text-align:center; }
        .result-player-name { font-weight:bold; color:#333; margin-bottom:6px; }
        .result-player-wins { font-size:2em; font-weight:bold; color:#667eea; }
    </style>
</head>
<body>
<div class="container">

<!-- –ú–ï–ù–Æ -->
<div class="screen active" id="screen-menu">
    <h1>ü¶â –°–æ–≤–∞ –ú—É–¥—Ä–æ—Å—Ç—ñ</h1>
    <div class="menu-buttons">
        <button class="btn-primary" onclick="showScreen('screen-setup')">üéÆ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
        <button class="btn-secondary" onclick="showScreen('screen-join')">üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
    </div>
</div>

<!-- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø -->
<div class="screen" id="screen-setup">
    <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <div class="form-group">
        <label>–¢–≤—ñ–π –Ω—ñ–∫–Ω–µ–π–º:</label>
        <input type="text" id="host-nick" placeholder="–í–≤–µ–¥–∏ –Ω—ñ–∫–Ω–µ–π–º" maxlength="16" />
    </div>
    <div class="form-group">
        <label>–ó–∞–≤–∞–Ω—Ç–∞–∂ —Ä—ñ–≤–Ω–æ 5 —Ñ–æ—Ç–æ –æ–¥—Ä–∞–∑—É:</label>
        <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">–ù–∞—Ç–∏—Å–Ω–∏ —â–æ–± –≤–∏–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ</div>
            <div class="upload-sub">–í–∏–±–µ—Ä–∏ –≤—Å—ñ 5 –æ–¥—Ä–∞–∑—É (Ctrl+A –∞–±–æ Shift+–∫–ª—ñ–∫)</div>
        </div>
        <input type="file" id="file-input" accept="image/*" multiple onchange="onFilesSelected()" />
    </div>
    <div class="images-preview" id="images-preview">
        <div class="preview-slot">üì∑<div class="slot-num">1</div></div>
        <div class="preview-slot">üì∑<div class="slot-num">2</div></div>
        <div class="preview-slot">üì∑<div class="slot-num">3</div></div>
        <div class="preview-slot">üì∑<div class="slot-num">4</div></div>
        <div class="preview-slot">üì∑<div class="slot-num">5</div></div>
    </div>
    <div id="trump-select" style="display:none; margin-bottom:12px;">
        <label style="font-weight:bold; color:#333;">‚≠ê –í–∏–±–µ—Ä–∏ –∫–æ–∑–∏—Ä—è:</label>
        <div class="trump-btns" id="trump-btns"></div>
    </div>
    <div class="error-msg" id="setup-error"></div>
    <button class="btn-primary" id="btn-create" onclick="createGame()" disabled>üöÄ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
    <br><br>
    <button class="btn-danger" onclick="showScreen('screen-menu')">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–Ø -->
<div class="screen" id="screen-join">
    <h2>üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</h2>
    <div class="form-group">
        <label>–¢–≤—ñ–π –Ω—ñ–∫–Ω–µ–π–º:</label>
        <input type="text" id="guest-nick" placeholder="–í–≤–µ–¥–∏ –Ω—ñ–∫–Ω–µ–π–º" maxlength="16" />
    </div>
    <div class="form-group">
        <label>–ö–æ–¥ –≥—Ä–∏:</label>
        <input type="text" id="join-code" placeholder="6 —Å–∏–º–≤–æ–ª—ñ–≤" maxlength="6"
               style="text-transform:uppercase;letter-spacing:4px;font-size:1.3em;text-align:center;" />
    </div>
    <div class="error-msg" id="join-error"></div>
    <button class="btn-secondary" onclick="joinGame()">üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
    <br><br>
    <button class="btn-danger" onclick="showScreen('screen-menu')">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –û–ß–Ü–ö–£–í–ê–ù–ù–Ø -->
<div class="screen" id="screen-waiting">
    <h2>‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</h2>
    <p style="text-align:center;color:#666;">–ü–æ–¥—ñ–ª–∏—Å—è –∫–æ–¥–æ–º –∑ –¥—Ä—É–≥–æ–º:</p>
    <div class="link-box" id="game-code-display">------</div>
    <button class="btn-primary" onclick="copyCode()">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥</button>
    <div class="copy-success" id="copy-success"></div>
    <span class="loader"></span>
    <button class="btn-danger" style="margin-top:10px;" onclick="cancelGame()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
</div>

<!-- –ì–†–ê -->
<div class="screen" id="screen-game">
    <div class="game-header">
        <div class="player-info">
            <div class="player-name" id="player1Name">–ì—Ä–∞–≤–µ—Ü—å 1</div>
            <div class="player-hand-count" id="player1Hand">5 –∫–∞—Ä—Ç</div>
        </div>
        <div class="vs-text">‚öîÔ∏è<div style="font-size:0.55em;color:#bbb;font-weight:normal;letter-spacing:1px;margin-top:3px;">–î—É–º–∞–π—Ç–µ</div></div>
        <div class="player-info">
            <div class="player-name" id="player2Name">–ì—Ä–∞–≤–µ—Ü—å 2</div>
            <div class="player-hand-count" id="player2Hand">5 –∫–∞—Ä—Ç</div>
        </div>
    </div>

    <div class="trump-bar">
        <div class="trump-thumb"><canvas id="trump-canvas" width="30" height="45"></canvas></div>
        ‚≠ê –ö–æ–∑–∏—Ä
    </div>

    <div class="table-area">
        <div class="game-status" id="gameStatus">...</div>
        <div class="table-cards" id="tableCards"></div>
    </div>

    <div class="opponent-cards" id="opponentCards"></div>
    <div class="my-cards" id="myCards"></div>

    <div class="action-buttons">
        <button class="btn-primary btn-action" id="btn-play" onclick="playCard()">‚öîÔ∏è –•–æ–¥–∏—Ç–∏</button>
        <button class="btn-secondary btn-action" id="btn-beat" onclick="beatCard()" style="display:none">üõ°Ô∏è –í—ñ–¥–±–∏—Ç–∏</button>
        <button class="btn-danger btn-action" id="btn-take" onclick="takeCards()" style="display:none">‚òùÔ∏è –í–∑—è—Ç–∏</button>
    </div>
</div>

<!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
<div class="screen" id="screen-result">
    <div class="result-winner" id="resultWinner">üéâ</div>
    <div class="result-scores">
        <div class="result-player">
            <div class="result-player-name" id="resultPlayer1">-</div>
            <div class="result-player-wins" id="resultWins1">0</div>
            <div style="color:#999;font-size:0.8em">–ø–µ—Ä–µ–º–æ–≥</div>
        </div>
        <div class="result-player">
            <div class="result-player-name" id="resultPlayer2">-</div>
            <div class="result-player-wins" id="resultWins2">0</div>
            <div style="color:#999;font-size:0.8em">–ø–µ—Ä–µ–º–æ–≥</div>
        </div>
    </div>
    <button class="btn-primary" id="btn-replay" onclick="requestReplay()">üîÑ –ù–æ–≤–∞ –ø–∞—Ä—Ç—ñ—è</button>
    <div id="replay-status" style="text-align:center;color:#667eea;margin-top:10px;min-height:22px;font-weight:bold;"></div>
    <button class="btn-danger" style="margin-top:10px;" onclick="location.reload()">üö™ –í–∏–π—Ç–∏</button>
</div>

</div><!-- /container -->

<script>
// ======= –ó–ê–ú–Ü–ù–ò –ù–ê –°–í–û–Ñ NGROK =======
const SERVER_URL = 'wss://tranquil-houston-aforethought.ngrok-free.dev';

// ======= STATE =======
let ws = null;
let myRole = null;
let myNick = '', opNick = '';
let myHand = [];
let opponentHandCount = 0;
let phase = 'idle';
let selectedCardIdx = null;
let trumpImg = 0;
let fieldCard = null;
let myWins = 0, opWins = 0;

// –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ Image –æ–±'—î–∫—Ç–∏
let loadedImages = [];   // loadedImages[i] = HTMLImageElement (–≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π)
let CARD_IMAGES_B64 = []; // base64 —Ä—è–¥–∫–∏

// ======= SETUP =======
function onFilesSelected() {
    const files = Array.from(document.getElementById('file-input').files);
    const err = document.getElementById('setup-error');
    if (files.length !== 5) {
        err.textContent = `‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–æ —Ä—ñ–≤–Ω–æ 5 —Ñ–æ—Ç–æ! –¢–∏ –≤–∏–±—Ä–∞–≤ ${files.length}.`;
        return;
    }
    err.textContent = '';
    CARD_IMAGES_B64 = new Array(5);
    loadedImages = new Array(5);
    let done = 0;

    files.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const b64 = e.target.result;
            CARD_IMAGES_B64[idx] = b64;

            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ Image –æ–±'—î–∫—Ç –æ–¥—Ä–∞–∑—É
            const img = new Image();
            img.onload = () => {
                loadedImages[idx] = img;
                done++;

                // –û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–µ–≤—å—é
                const slots = document.querySelectorAll('.preview-slot');
                slots[idx].innerHTML = `<img src="${b64}"><div class="slot-num">${idx+1}</div>`;

                if (done === 5) allImagesReady();
            };
            img.src = b64;
        };
        reader.readAsDataURL(file);
    });
}

function allImagesReady() {
    // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫–∏ –∫–æ–∑–∏—Ä—è
    document.getElementById('trump-select').style.display = 'block';
    const btns = document.getElementById('trump-btns');
    btns.innerHTML = '';
    for (let i = 0; i < 5; i++) {
        const b = document.createElement('button');
        b.textContent = `–ö–∞—Ä—Ç–∏–Ω–∫–∞ ${i+1}`;
        b.className = 'trump-btn' + (i === 0 ? ' active' : '');
        b.onclick = () => selectTrump(i);
        btns.appendChild(b);
    }
    selectTrump(0);

    const uz = document.getElementById('upload-zone');
    uz.classList.add('done');
    uz.querySelector('.upload-text').textContent = '‚úÖ 5 —Ñ–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!';
    document.getElementById('btn-create').disabled = false;
}

function selectTrump(idx) {
    trumpImg = idx;
    document.querySelectorAll('.trump-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    document.querySelectorAll('.preview-slot').forEach((s, i) => s.classList.toggle('trump', i === idx));
}

// ======= –ú–ê–õ–Æ–í–ê–ù–ù–Ø –ü–û–õ–û–í–ò–ù–ò –ö–ê–†–¢–ò =======
// –ü–æ–≤–µ—Ä—Ç–∞—î canvas element –∑ –ø–æ–ª–æ–≤–∏–Ω–æ—é –∫–∞—Ä—Ç–∏–Ω–∫–∏
function makeCardCanvas(imgIdx, half, w, h) {
    const img = loadedImages[imgIdx];
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    if (!img) return canvas;
    const ctx = canvas.getContext('2d');
    const sx = half === 0 ? 0 : img.naturalWidth / 2;
    ctx.drawImage(img, sx, 0, img.naturalWidth / 2, img.naturalHeight, 0, 0, w, h);
    return canvas;
}

function cardToDataURL(imgIdx, half) {
    return makeCardCanvas(imgIdx, half, 75, 115).toDataURL();
}

// ======= WEBSOCKET =======
function connect(cb) {
    ws = new WebSocket(SERVER_URL);
    ws.onopen = cb;
    ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
    ws.onerror = () => alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è!');
    ws.onclose = () => {
        if (document.getElementById('screen-game').classList.contains('active')) {
            document.getElementById('resultWinner').textContent = 'üíî –°—É–ø–µ—Ä–Ω–∏–∫ –≤—ñ–¥–∫–ª—é—á–∏–≤—Å—è';
            showScreen('screen-result');
        }
    };
}

function sendWS(d) {
    if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(d));
}

// ======= GAME ACTIONS =======
function createGame() {
    myNick = document.getElementById('host-nick').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å 1';
    connect(() => sendWS({ type: 'create-game', nickname: myNick, images: CARD_IMAGES_B64, trumpImg }));
}

function joinGame() {
    myNick = document.getElementById('guest-nick').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å 2';
    const code = document.getElementById('join-code').value.trim().toUpperCase();
    if (!code) { document.getElementById('join-error').textContent = '–í–≤–µ–¥–∏ –∫–æ–¥!'; return; }
    connect(() => sendWS({ type: 'join-game', gameId: code, nickname: myNick }));
}

function copyCode() {
    navigator.clipboard.writeText(document.getElementById('game-code-display').textContent)
        .then(() => {
            document.getElementById('copy-success').textContent = '‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!';
            setTimeout(() => document.getElementById('copy-success').textContent = '', 2000);
        });
}

function cancelGame() { if (ws) ws.close(); showScreen('screen-menu'); }

function requestReplay() {
    document.getElementById('btn-replay').disabled = true;
    document.getElementById('replay-status').textContent = '‚è≥ –ß–µ–∫–∞—î–º–æ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...';
    sendWS({ type: 'replay' });
}

function selectCard(idx) {
    if (phase !== 'attack' && phase !== 'defend') return;
    selectedCardIdx = selectedCardIdx === idx ? null : idx;
    renderMyCards();
}

function playCard() {
    if (selectedCardIdx === null) { alert('–í–∏–±–µ—Ä–∏ –∫–∞—Ä—Ç—É!'); return; }
    const card = myHand[selectedCardIdx];
    if (card.img === trumpImg && myHand.length === 1) {
        alert('‚ùå –ö–æ–∑–∏—Ä–µ–º –Ω–µ –º–æ–∂–Ω–∞ —Ö–æ–¥–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—å–æ—é –∫–∞—Ä—Ç–æ—é!'); return;
    }
    sendWS({ type: 'attack', card: { img: card.img, half: card.half } });
}

function beatCard() {
    if (selectedCardIdx === null) { alert('–í–∏–±–µ—Ä–∏ –∫–∞—Ä—Ç—É!'); return; }
    const card = myHand[selectedCardIdx];
    if (card.img === trumpImg && myHand.length === 1) {
        alert('‚ùå –ö–æ–∑–∏—Ä–µ–º –Ω–µ –º–æ–∂–Ω–∞ –≤—ñ–¥–±–∏–≤–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—å–æ—é –∫–∞—Ä—Ç–æ—é!'); return;
    }
    sendWS({ type: 'defend', card: { img: card.img, half: card.half } });
}

function takeCards() {
    selectedCardIdx = null;
    sendWS({ type: 'take-cards' });
}

// ======= MESSAGES =======
function handleMessage(data) {
    switch (data.type) {
        case 'game-created':
            document.getElementById('game-code-display').textContent = data.gameId;
            showScreen('screen-waiting');
            break;

        case 'player-joined':
            opNick = data.guestNick;
            setTimeout(() => sendWS({ type: 'start-game' }), 500);
            break;

        case 'joined':
            opNick = data.hostNick;
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤—ñ–¥ —Ö–æ—Å—Ç–∞
            CARD_IMAGES_B64 = data.images;
            trumpImg = data.trumpImg;
            loadedImages = new Array(5);
            let loaded = 0;
            data.images.forEach((b64, idx) => {
                const img = new Image();
                img.onload = () => { loadedImages[idx] = img; loaded++; };
                img.src = b64;
            });
            break;



        case 'attack-sent':
            myHand = data.hand;
            fieldCard = data.card;
            phase = 'wait';
            renderAll();
            break;

        case 'incoming-attack':
            fieldCard = data.card;
            phase = 'defend';
            opponentHandCount--;
            renderAll();
            break;

        case 'defend-success':
            myHand = data.hand;
            fieldCard = null;
            selectedCardIdx = null;
            phase = data.attacker === myRole ? 'attack' : 'wait';
            renderAll();
            break;

        case 'took-cards':
            myHand = data.hand;
            fieldCard = null;
            selectedCardIdx = null;
            phase = 'wait';
            renderAll();
            break;

        case 'opponent-took':
            opponentHandCount += fieldCard ? 1 : 0;
            fieldCard = null;
            selectedCardIdx = null;
            phase = 'attack';
            renderAll();
            break;

        case 'invalid-defend':
            alert('‚ùå –¢–∞–∫ –Ω–µ –º–æ–∂–Ω–∞ –≤—ñ–¥–±–∏—Ç–∏!');
            break;

        case 'error':
            document.getElementById('join-error').textContent = '‚ùå ' + data.message;
            break;

        case 'game-over':
            // –†–∞—Ö—É–Ω–æ–∫ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∑ —Å–µ—Ä–≤–µ—Ä–∞
            myWins = myRole === 'host' ? data.hostWins : data.guestWins;
            opWins = myRole === 'host' ? data.guestWins : data.hostWins;
            showResult(data.winner === myRole);
            break;

        case 'opponent-left':
            showResult(true);
            break;

        case 'waiting-replay':
            document.getElementById('replay-status').textContent = '‚è≥ –ß–µ–∫–∞—î–º–æ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...';
            document.getElementById('btn-replay').disabled = true;
            break;

        case 'opponent-ready-replay':
            document.getElementById('replay-status').textContent = '‚úÖ –°—É–ø–µ—Ä–Ω–∏–∫ –≥–æ—Ç–æ–≤–∏–π! –ù–∞—Ç–∏—Å–∫–∞–π "–ù–æ–≤–∞ –ø–∞—Ä—Ç—ñ—è"';
            break;

        case 'game-start':
            myRole = data.role;
            trumpImg = data.trumpImg;
            if (data.images) CARD_IMAGES_B64 = data.images;
            if (data.hostWins !== undefined) {
                myWins = myRole === 'host' ? data.hostWins : data.guestWins;
                opWins = myRole === 'host' ? data.guestWins : data.hostWins;
            }
            // –Ø–∫—â–æ –≥—ñ—Å—Ç—å —ñ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ ‚Äî —á–µ–∫–∞—î–º–æ
            if (myRole === 'guest' && loadedImages.filter(Boolean).length < 5) {
                waitImagesAndStart(data);
            } else {
                startGameUI(data);
            }
            break;
    }
}

function waitImagesAndStart(data) {
    // –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ –≤—Å—ñ 5 –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è
    const check = setInterval(() => {
        if (loadedImages.filter(Boolean).length === 5) {
            clearInterval(check);
            startGameUI(data);
        }
    }, 100);
}

function startGameUI(data) {
    myHand = data.hand;
    opponentHandCount = 5;
    fieldCard = null;
    selectedCardIdx = null;
    phase = data.attacker === myRole ? 'attack' : 'wait';

    document.getElementById('player1Name').textContent = myNick;
    document.getElementById('player2Name').textContent = opNick;
    setupTrumpCanvas();
    renderAll();
    // –°–∫–∏–¥–∞—î–º–æ UI —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –ø–∞—Ä—Ç—ñ—ó
    document.getElementById('btn-replay').disabled = false;
    document.getElementById('replay-status').textContent = '';
    showScreen('screen-game');
}

function setupTrumpCanvas() {
    const trumpCanvas = document.getElementById('trump-canvas');
    const tCtx = trumpCanvas.getContext('2d');
    tCtx.clearRect(0, 0, 30, 45);
    const tImg = loadedImages[trumpImg];
    if (tImg) {
        tCtx.drawImage(tImg, 0, 0, tImg.naturalWidth / 2, tImg.naturalHeight, 0, 0, 30, 45);
    }
}

// ======= RENDER =======
function renderAll() {
    renderMyCards();
    renderOpponentCards();
    renderTable();
    renderStatus();
    renderButtons();
}

function renderMyCards() {
    const div = document.getElementById('myCards');
    div.innerHTML = '';
    document.getElementById('player1Hand').textContent = `${myHand.length} –∫–∞—Ä—Ç`;

    myHand.forEach((card, idx) => {
        const isTrump = card.img === trumpImg;
        const isSelected = selectedCardIdx === idx;

        const img = document.createElement('img');
        img.src = cardToDataURL(card.img, card.half);
        img.className = 'card-in-hand' + (isTrump ? ' trump' : '') + (isSelected ? ' selected' : '');
        img.onclick = () => selectCard(idx);
        div.appendChild(img);
    });
}

function renderOpponentCards() {
    const div = document.getElementById('opponentCards');
    div.innerHTML = '';
    document.getElementById('player2Hand').textContent = `${opponentHandCount} –∫–∞—Ä—Ç`;
    for (let i = 0; i < opponentHandCount; i++) {
        const d = document.createElement('div');
        d.className = 'card-back';
        d.textContent = 'ü¶â';
        div.appendChild(d);
    }
}

function renderTable() {
    const div = document.getElementById('tableCards');
    div.innerHTML = '';
    if (!fieldCard) return;
    const isTrump = fieldCard.img === trumpImg;
    const img = document.createElement('img');
    img.src = cardToDataURL(fieldCard.img, fieldCard.half);
    img.className = 'card-on-table' + (isTrump ? ' trump' : '');
    div.appendChild(img);
}

function renderStatus() {
    const s = document.getElementById('gameStatus');
    if (phase === 'attack') s.textContent = '‚öîÔ∏è –í–∞—à —Ö—ñ–¥ ‚Äî –≤–∏–±–µ—Ä–∏ –∫–∞—Ä—Ç—É';
    else if (phase === 'defend') s.textContent = 'üõ°Ô∏è –í—ñ–¥–±–∏–π –∞–±–æ –≤—ñ–∑—å–º–∏ –∫–∞—Ä—Ç–∏';
    else s.textContent = '‚è≥ –•—ñ–¥ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...';
}

function renderButtons() {
    document.getElementById('btn-play').style.display = phase === 'attack' ? 'block' : 'none';
    document.getElementById('btn-beat').style.display = phase === 'defend' ? 'block' : 'none';
    document.getElementById('btn-take').style.display = phase === 'defend' ? 'block' : 'none';
}

function showResult(iWon) {
    document.getElementById('resultWinner').textContent = iWon ? 'üéâ –í–∏ –≤–∏–≥—Ä–∞–ª–∏!' : 'üòî –í–∏ –ø—Ä–æ–≥—Ä–∞–ª–∏';
    document.getElementById('resultPlayer1').textContent = myNick;
    document.getElementById('resultPlayer2').textContent = opNick;
    document.getElementById('resultWins1').textContent = myWins;
    document.getElementById('resultWins2').textContent = opWins;
    showScreen('screen-result');
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}
</script>
</body>
</html>
